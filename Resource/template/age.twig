{#
 This file is part of the Sales Report plugin

Copyright (C) 2016 LOCKON CO.,LTD. All Rights Reserved.

 For the full copyright and license information, please view the LICENSE
 file that was distributed with this source code.
#}

{% extends 'SalesReport/Resource/template/index.twig' %}

{% set report_title = '年代別集計' %}
{% set action = url('admin_plugin_sales_report_age') %}
{% set menus = ['admin_plugin_sales_report', 'admin_plugin_sales_report_age'] %}

{% block chart %}
    <script>
        var graphData = {{ graphData|raw }};
        window.onload = function() {
            //create bar chart
            if(graphData != null) {
                var dataSet = graphData.datasets;
                graphData.datasets = [dataSet];
                var config = {
                    type: 'bar',
                    data: graphData,
                    options: {
                        responsive: true,
                        tooltips: {
                            callbacks: {
                                label : function tooltipsRender(tooltipItem, graphData) {
                                    var index = tooltipItem.index;
                                    var tooltipData = graphData.datasets[0].data[index];
                                    var tooltipLabel = graphData.labels[index];
                                    return '購入合計 : ¥' + moneyFormat(tooltipData);
                                }
                            }
                        },
                        legend: {
                            display: false
                        }
                    }
                };
                var ctx = document.getElementById("chart").getContext("2d");
                new Chart(ctx, config);
            }
            //export csv
            $('#export-csv').click(function () {
                $("#age-table").tableToCSV();
            });
        };
    </script>
{% endblock %}

{% block option %}{% endblock %}

{% block table %}
    {% if app.request.method == 'POST' and rawData is not null %}
    <div class="row">
        <div class="flR" style="margin: 10px 20px 10px 0;">
            <a id="export-csv" class="btn btn-default" data-export="export">CSV ダウンロード</a>
        </div>
        <div class="col-md-12">
            <div class="box">
                <div class="box-body no-header no-padding">
                    <div class="table-responsive">
                        <table class="table table-striped" id="age-table">
                            <thead>
                            <tr>
                                <th>年齢</th>
                                <th>購入件数</th>
                                <th>購入合計</th>
                                <th>購入平均</th>
                            </tr>
                            </thead>
                            <tbody>
                            {% for age, row in rawData %}
                                <tr>
                                    <td>{{ age }}</td>
                                    <td>{{ row.time|number_format }}</td>
                                    <td class="price-format">
                                        {{ row.total|price }}
                                        <span class="hidden">{{ row.total }}</span>
                                    </td>
                                    <td class="price-format">
                                        {% if row.time > 0 %}
                                            {{ (row.total / row.time)|round(2, 'floor')|price }}
                                        {% else %}
                                            -
                                        {% endif %}
                                        <span class="hidden">
                                            {% if row.time > 0 %}
                                                {{ (row.total / row.time)|round(2, 'floor') }}
                                            {% else %}
                                                -
                                            {% endif %}
                                        </span>
                                    </td>
                                </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div><!-- /.box-body -->
            </div><!-- /.box -->
        </div><!-- /.col -->
    </div>
    {% endif %}
{% endblock %}
